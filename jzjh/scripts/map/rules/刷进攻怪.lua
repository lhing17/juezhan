---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by G_Seinfeld.
--- DateTime: 2018/11/14 0014 20:20
---


-- 刷一个进攻怪 from 起点的loc to_rect 终点的rect
local function pawn_attack_creep(id, from, to_rect)
    local p = et.player(7)
    local last = p:create_unit(id, et.point(jass.GetLocationX(from), jass.GetLocationY(from)))
    game.variable.attack_creeps[last.handle] = last
    last:issue_order(851983, et.get_rect_center(to_rect))
    return last
end

--判断玩家总等级是否大于波数*4
local function excessive_level()
    local totallevel = 0
    for i = 1, et.player.countAlive() do
        if et.player(i).hero then
            totallevel = totallevel + et.player(i).hero.handle:get_level()
        end
    end
    return game.config.mode == 'special' and totallevel > game.variable.wave * 4 * et.player.countAlive()
end
local function attacker_add_skill(u)
    if game.variable.wave >= 8 then
        u:add_ability(1093682008)
    elseif game.variable.wave >= 18 then
        u:add_ability(1093682009)
    elseif game.variable.wave >= 28 then
        u:add_ability(1093682010)
    end
end
-- 正面刷怪
local function front_attack()
    et.timer(3000, 20, function()
        if game.config.mode ~= 'survive' then
            pawn_attack_creep(y7[game.variable.wave], v7[6], Ke)
            pawn_attack_creep(y7[game.variable.wave], v7[7], Ke)
            pawn_attack_creep(y7[game.variable.wave], v7[5], Ke)
            if excessive_level() then
                pawn_attack_creep(y7[game.variable.wave], v7[6], Ke)
                pawn_attack_creep(y7[game.variable.wave], v7[7], Ke)
                pawn_attack_creep(y7[game.variable.wave], v7[5], Ke)
            end
        else
            pawn_attack_creep(1848651827, v7[6], Ke)
            pawn_attack_creep(1848651827, v7[7], Ke)
            pawn_attack_creep(1848651827, v7[5], Ke)
        end
    end)
end

-- 背面刷怪
local function back_attack()
    if et.player.countAlive() > 1 then
        et.wait(40 * 1000, function()
            et.timer(2000, 15, function()
                if game.config.mode ~= 'survive' then
                    pawn_attack_creep(y7[game.variable.wave + 1], v7[8], Je)
                    if excessive_level() then
                        pawn_attack_creep(y7[game.variable.wave + 1], v7[8], Je)
                    end
                else
                    local last = pawn_attack_creep(1848651827, v7[8], Je)
                    attacker_add_skill(last)
                end
            end)
            force.send_message("|CFFFF0033邪教趁我方不备，偷偷地从背后杀过来了")
        end)
    end
end


--BOSS成长
local function boss_grow_up()
    if udg_boss[game.variable.wave // 4] then
        local u = et.unit(udg_boss[game.variable.wave // 4])
        if u:is_alive() then
            if not u:has_ability(1093682242) then
                u:add_ability(1093682242)
                force.send_message("|CFFFF0033邪教BOSS" .. u:get_name() .. "已加强")
            else
                if u:get_ability_level(1093682242) < 10 then
                    u:set_ability_level(1093682242, u:get_ability_level(1093682242) + 1)
                    force.send_message("|CFFFF0033邪教BOSS" .. u:get_name() .. "已加强")
                end
            end
            if not u:has_ability(1093682000) then
                u:add_ability(1093682000)
            else
                if u:get_ability_level(1093682000) < 6 then
                    u:set_ability_level(1093682000, u:get_ability_level(1093682000) + 1)
                else
                    u:add_ability(1093681969)
                end
            end
        end
    end
end

local wave_warning = {}
wave_warning[9] = "|CFFFF0033※警告※：下一波怪拥有技能神圣护甲和10倍暴击"
wave_warning[11] = "|CFFFF0033※警告※：下一波怪拥有技能咆哮和重击"
wave_warning[12] = "|CFFFF0033※警告※：下一波怪为空军"
wave_warning[13] = "|CFFFF0033※警告※：下一波怪拥有技能噬血术"
wave_warning[14] = "|CFFFF0033※警告※：下一波怪为绞肉车，死亡后会产生小蜘蛛"
wave_warning[15] = "|CFFFF0033※警告※：下一波怪为空军，拥有技能20倍暴击"
wave_warning[16] = "|CFFFF0033※警告※：下一波怪拥有技能精灵之火"
wave_warning[17] = "|CFFFF0033※警告※：下一波怪拥有技能狂战士和30倍暴击"
wave_warning[18] = "|CFFFF0033※警告※：下一波怪血量很高，并拥有技能嘲讽"
wave_warning[19] = "|CFFFF0033※警告※：下一波怪拥有技能狂热"
wave_warning[20] = "|CFFFF0033※警告※：下一波怪拥有技能变相移动"
wave_warning[21] = "|CFFFF0033※警告※：下一波怪拥有技能反魔法外壳"
wave_warning[22] = "|CFFFF0033※警告※：下一波怪拥有技能重击"
wave_warning[23] = "|CFFFF0033※警告※：下一波怪拥有技能90%闪避"
wave_warning[24] = "|CFFFF0033※警告※：下一波怪拥有技能卡布恩（自爆）"
wave_warning[25] = "|CFFFF0033※警告※：下一波怪拥有技能闪电攻击"
wave_warning[26] = "|CFFFF0033※警告※：下一波怪拥有技能神圣护甲"
wave_warning[27] = "|CFFFF0033※警告※：下一波怪血量很高，并拥有技能永久献祭和重生"
wave_warning[28] = "|CFFFF0033※警告※：本波为最后一波进攻，本波结束后教主即将出现"

-- 下一波怪的警告
local function show_next_wave_warning()
    if wave_warning[game.variable.wave] then
        force.send_message(wave_warning[game.variable.wave])
    end
end

local boss_skill_list = {}

boss_skill_list[1852007794] = { 1093681970, 1093681973, 1093681975 }
boss_skill_list[1852335457] = { 1093681990, 1093682241 }
boss_skill_list[1852599148] = { 1093681993, 1093681994, 1093681998 }
boss_skill_list[1852140645] = { 1093681976, 1093681977, 1093681986 }
boss_skill_list[1852141168] = { 1093681992, 1093682245 }
boss_skill_list[1851941985] = { 1093681995, 1093682248 }
boss_skill_list[1848651826] = {}
boss_skill_list[1851942003] = {}

local function boss_attack()
    et.wait(80 * 1000, function()
        local id = u7[game.variable.wave // 4]
        if math.fmod(game.variable.wave, 4) == 0 and game.variable.wave < 28 and game.config.mode ~= 'survive' then
            pawn_attack_creep(id, v7[8], Je)
            force.send_message("|CFFFF0033邪教趁我方不备，偷偷地派出BOSS从背后杀过来了，请准备防御")
        end
        if ModuloInteger(game.variable.wave, 4) == 0 and game.variable.wave < 30 and game.config.mode ~= 'survive' then
            force.send_message("|CFFFF0033邪教派出BOSS前来进攻，请准备防御")
            local boss = pawn_attack_creep(id, v7[6], Ke)
            if boss_skill_list[id] then
                for _, v in ipairs(boss_skill_list[id]) do
                    boss:add_ability(v, IMinBJ(udg_nandu * 2, 9))
                end
            end
            udg_boss[game.variable.wave // 4] = boss
            et.timer(20 * 1000, 5, boss_grow_up)
        elseif math.fmod(game.variable.wave, 4) ~= 0 and game.variable.wave < 28 and game.config.mode ~= 'survive' then
            if excessive_level() then
                force.send_message("|CFFFF0033由于激活特殊事件，邪教派出BOSS前来进攻，请准备防御")
                local boss = pawn_attack_creep(id, v7[6], Ke)
                udg_boss[game.variable.wave // 4] = boss
                et.timer(20 * 1000, 5, boss_grow_up)
            end
        end
    end)

end

local function famous_attack()
    et.wait(60 * 1000, function()
        if game.variable.famous_num > 0 then
            if game.config.pawn then
                local r1 = 0
                local r2 = 0
                if game.variable.famous_num == 1 then
                    r1 = 1.26
                    r2 = 1.4
                elseif game.variable.famous_num == 2 then
                    r1 = 1.28
                    r2 = 1.43
                elseif game.variable.famous_num == 3 then
                    r1 = 1.3
                    r2 = 1.46
                elseif game.variable.famous_num == 4 then
                    r1 = 1.32
                    r2 = 1.49
                elseif game.variable.famous_num == 5 then
                    r1 = 1.34
                    r2 = 1.52
                end
                for i = 1, game.variable.famous_num do
                    rr3 = r1 ^ game.variable.wave
                    rr4 = r2 ^ game.variable.wave
                    rand = jass.GetRandomInt(1, 11)
                    local famous = pawn_attack_creep(et.famous[rand].id, v7[GetRandomInt(5, 8)], Ke)
                    famous:set_level(4 * game.variable.wave)
                    YDWEGeneralBounsSystemUnitSetBonus(famous.handle, 3, 0, R2I(et.famous[rand]["攻击成长"] * rr3 * 3.3))
                    YDWEGeneralBounsSystemUnitSetBonus(famous.handle, 2, 0, (game.variable.wave - 1) * et.famous[rand]["防御成长"] * 9 // 10 * game.variable.famous_num)
                    famous:add_item(Ae[game.variable.wave])
                end
            end
            force.send_message("|CFFFF0033名门高手开始进攻，大家要小心应付了！")
        end
    end)
end

-- 实际执行刷怪的逻辑
function do_pawn()
    -- 试玩模式下不刷怪
    if not game.config.pawn then
        return
    end
    -- 特殊事件模式第5波再次选择难度
    if game.variable.wave == 5 and game.config.mode == 'special' then
        choose_difficulty()
    end

    force.send_message("|CFFFF0033邪教势力：第" .. game.variable.wave .. "波")
    show_next_wave_warning() --下波警告
    if excessive_level() then
        force.send_message("|CFFFF0033激活特殊事件|cFFDDA0DD※邪教全力进攻※")
    end
    jass.StopMusic(false)
    jass.PlayMusic(game.music.attack_bgm) -- 切换BGM
    front_attack()-- 刷正面的进攻怪
    back_attack() -- 刷背面的进攻怪
    famous_attack() -- 刷名门
    boss_attack() -- 刷BOSS
    et.wait(80 * 1000, function()
        game.variable.wave = game.variable.wave + 1
        jass.StopMusic(false)
        jass.PlayMusic(game.music.normal_bgm)
        local wait_time = 0
        if game.config.mode ~= 'fast' then
            wait_time = 145 - et.player.countAlive() * 10
        end
        log.debug('wait_time', wait_time)
        et.wait(wait_time * 1000, function()
            if game.variable.wave >= 29 and game.config.mode ~= 'survive' then
                jass.StopMusic(false)
                jass.PlayMusic(game.music.final_bgm)
                force.send_message("|CFFFF0033西域势力最后BOSS即将发起最后进攻，请作好防守准备")
                local last = pawn_attack_creep(u7[8], v7[6], Ke)
                udg_boss[game.variable.wave // 4] = last.handle
                et.timer(20 * 1000, 5, boss_grow_up)
            else
                if game.config.mode == 'survive' then
                    jass.AddPlayerTechResearched(Player(12), 1378889780, 1)
                    jass.AddPlayerTechResearched(Player(6), 1378889780, 1)
                end
                log.debug("邪教下次进攻时间:", game.variable.stop_time * 60.0 + 30.0)
                et.timerdialog(game.variable.stop_time * 60.0 + 30.0, "邪教下次进攻时间")
                et.wait((game.variable.stop_time * 60.0 + 30.0) * 1000, function()
                    do_pawn()
                end)
                game.variable.stop_time = 0
            end
        end)

    end)
end

local function init()

    -- 游戏开始后40秒开始进攻倒计时
    et.wait(40 * 1000, function()
        log.debug("邪教进攻倒计时：")
        et.timerdialog(120, "邪教进攻倒计时：")
        et.wait(120 * 1000, function()
            force.send_message("|cFFDDA0DD西域邪教开始了进攻正派武林，玩家务必要确保正派武林不被摧毁，否则游戏失败|r")
            if game.config.mode == 'special' then
                choose_difficulty()
            end
            do_pawn()
        end)
    end)

    -- 停怪
    et.game:event '单位-捡起物品'(function(self, u, item)
        if jass.GetItemTypeId(item) == 1227894853 then
            local p = u:get_owner()
            local h = p.hero
            game.variable.stop_time = game.variable.stop_time + 1
            force.send_message("|CFF00FF4C在武林弟子的奋力帮助下，邪教的进攻势力被延缓了，大家有1分钟的时间，赶紧去做任务吧~")
            PlaySoundOnUnitBJ(Dh, 100, u.handle)
            h.def_point = h.def_point + 10
            p:send_message("|CFF00FF4C守家积分+10")
        end
    end)
end

init()