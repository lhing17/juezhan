---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by G_Seinfeld.
--- DateTime: 2018/11/15 21:30
---

function GetBookNum(id)
    for i = 1, #kongfu do
        if kongfu[i].itemid == id then
            return i
        end
    end
    return 0
end
function LearnJiNeng(l__ut, it)
    local p = GetOwningPlayer(l__ut)
    local i = 1 + GetPlayerId(p)
    local u = udg_hero[i]
    local num = GetBookNum(GetItemTypeId(it))
    local id = kongfu[num].abilityid
    local dp1 = kongfu[num].conditions['胆魄']
    local fy1 = kongfu[num].conditions['福缘']
    local gg1 = kongfu[num].conditions['根骨']
    local jm1 = kongfu[num].conditions['经脉']
    local wx1 = kongfu[num].conditions['悟性']
    local ys1 = kongfu[num].conditions['医术']
    if GetUnitAbilityLevel(u, id) > 0 then
        DisplayTextToPlayer(p, 0, 0, "|CFFFF0033你已经拥有此武功了")
        unitadditembyidswapped(GetItemTypeId(it), l__ut)
    else
        if danpo[i] >= dp1 and fuyuan[i] >= fy1 and gengu[i] >= gg1 and jingmai[i] >= jm1 and wuxing[i] >= wx1 and yishu[i] >= ys1 then
            if id == 1093677905 then
                UnitAddAbility(u, id)
                UnitMakeAbilityPermanent(u, true, id)
                DisplayTextToForce(bj_FORCE_ALL_PLAYERS, "|CFFFF0033恭喜" .. (GetPlayerName(p) or "") .. "习得" .. (GetObjectName(id) or ""))
                AddPlayerTechResearched(p, 1382576745, 1)
            else
                L7[i] = 1
                for _ in _loop_() do
                    if L7[i] > wugongshu[i] then break end
                    if I7[20 * (i - 1) + L7[i]] ~= 1095067243 then
                        if L7[i] == wugongshu[i] then
                            DisplayTextToPlayer(p, 0, 0, "|CFFFF0033学习技能已达上限，请先遗忘部分技能")
                            unitadditembyidswapped(GetItemTypeId(it), l__ut)
                        end
                    else
                        UnitAddAbility(u, id)
                        UnitMakeAbilityPermanent(u, true, id)
                        if LoadInteger(YDHT, GetHandleId(GetOwningPlayer(u)), id * 5) >= 2 then
                            SetUnitAbilityLevel(u, id, LoadInteger(YDHT, GetHandleId(GetOwningPlayer(u)), id * 5))
                        end
                        I7[20 * (i - 1) + L7[i]] = id
                        if GetUnitAbilityLevel(u, id) >= 2 then
                            DisplayTextToForce(bj_FORCE_ALL_PLAYERS, "|CFFFF0033恭喜" .. (GetPlayerName(p) or "") .. "想起" .. (GetObjectName(id) or ""))
                        else
                            DisplayTextToForce(bj_FORCE_ALL_PLAYERS, "|CFFFF0033恭喜" .. (GetPlayerName(p) or "") .. "习得" .. (GetObjectName(id) or ""))
                        end
                        S9 = 1
                        for _ in _loop_() do
                            if S9 > 20 then break end
                            if id == MM9[S9] then
                                udg_shanghaijiacheng[i] = udg_shanghaijiacheng[i] + udg_jueneishjc[S9]
                                ModifyHeroStat(1, u, 0, udg_jueneiminjie[S9])
                                udg_baojilv[i] = udg_baojilv[i] + udg_jueneibaojilv[S9]
                                juexuelingwu[i] = juexuelingwu[i] + udg_jueneijxlw[S9]
                                udg_shanghaixishou[i] = udg_shanghaixishou[i] + udg_jueneishxs[S9]
                            end
                            S9 = S9 + 1
                        end
                        if true then break end
                    end
                    L7[i] = L7[i] + 1
                end
            end
        else
            DisplayTextToPlayer(p, 0, 0, "|CFFFF0033学习条件不足")
            if danpo[i] >= dp1 then
            else
                DisplayTextToPlayer(p, 0, 0, "|CFFFF0033胆魄缺少：" .. (I2S(dp1 - danpo[i]) or ""))
            end
            if gengu[i] >= gg1 then
            else
                DisplayTextToPlayer(p, 0, 0, "|CFFFF0033根骨缺少：" .. (I2S(gg1 - gengu[i]) or ""))
            end
            if fuyuan[i] >= fy1 then
            else
                DisplayTextToPlayer(p, 0, 0, "|CFFFF0033福缘缺少：" .. (I2S(fy1 - fuyuan[i]) or ""))
            end
            if wuxing[i] >= wx1 then
            else
                DisplayTextToPlayer(p, 0, 0, "|CFFFF0033悟性缺少：" .. (I2S(wx1 - wuxing[i]) or ""))
            end
            if jingmai[i] >= jm1 then
            else
                DisplayTextToPlayer(p, 0, 0, "|CFFFF0033经脉缺少：" .. (I2S(jm1 - jingmai[i]) or ""))
            end
            if yishu[i] >= ys1 then
            else
                DisplayTextToPlayer(p, 0, 0, "|CFFFF0033医术缺少：" .. (I2S(ys1 - yishu[i]) or ""))
            end
            unitadditembyidswapped(GetItemTypeId(it), l__ut)
        end
    end
    p = nil
    u = nil
end
--学习武功
function IsWuGongBook()
    return GetBookNum(GetItemTypeId(GetManipulatedItem())) ~= 0
end
function BookLearnWuGong()
    LearnJiNeng(GetTriggerUnit(), GetManipulatedItem())
end
--内功加成属性
function NeiGongJiaCheng(i, id, baoji, shxs, jxlw, minjie, shjc)
    MM9[i] = id
    udg_jueneibaojilv[i] = baoji
    udg_jueneishxs[i] = shxs
    udg_jueneijxlw[i] = jxlw
    udg_jueneiminjie[i] = minjie
    udg_jueneishjc[i] = shjc
end
function NeiGongJiaChengS()
    --序号、ID、暴击率、伤害吸收、绝学领悟、内力、伤害加成
    NeiGongJiaCheng(1, 1093682232, 0.15, 0.2, 5, 30, 1.0)
    NeiGongJiaCheng(2, 1093679154, 0.08, 0.25, 4, 150, 0.4)
    NeiGongJiaCheng(3, 1093679155, 0.05, 0.3, 3, 100, 0.3)
    NeiGongJiaCheng(4, 1093679428, 0.06, 0.4, 4, 120, 0.8)
    NeiGongJiaCheng(5, 1093679152, 0.12, 0.2, 3, 130, 0.7)
    NeiGongJiaCheng(6, 1093678936, 0.16, 0.15, 3, 60, 0.5)
    NeiGongJiaCheng(7, 1093679156, 0.1, 0.1, 2, 80, 0.6)
    NeiGongJiaCheng(8, 1395666994, 0.2, 0.2, 1, 50, 0.9)
    NeiGongJiaCheng(9, 1093678927, 0.04, 0, 0, 25, 0.2)
    NeiGongJiaCheng(10, 1093678928, 0.06, 0, 0, 30, 0.12)
    NeiGongJiaCheng(11, 1093678929, 0.08, 0, 0, 30, 0.14)
    NeiGongJiaCheng(12, 1093678930, 0.06, 0, 0, 20, 0.15)
    NeiGongJiaCheng(13, 1093678931, 0.1, 0, 0, 40, 0.25)
    NeiGongJiaCheng(14, 1093678932, 0.1, 0, 0, 30, 0.3)
    NeiGongJiaCheng(15, 1093678933, 0.07, 0, 0, 50, 0.18)
    NeiGongJiaCheng(16, 1093678935, 0.09, 0, 0, 50, 0.1)
    NeiGongJiaCheng(17, 1093682254, 0.03, 0, 0, 40, 0.18)
    NeiGongJiaCheng(18, 1093682226, 0.2, 0, 0, 80, 0.5)
    NeiGongJiaCheng(19, 1093682230, 0.8, 0, 0, 10, 0.15)
    NeiGongJiaCheng(20, 1093682228, -0.2, 0, 0, -40, -0.25)
end
--------学习武功系统结束------

local function init()

    -- 学习武功
    cj = CreateTrigger()
    TriggerRegisterAnyUnitEventBJ(cj, EVENT_PLAYER_UNIT_USE_ITEM)
    TriggerAddCondition(cj, Condition(IsWuGongBook))
    TriggerAddAction(cj, BookLearnWuGong)
    -- 初始化内功加成
    fk = CreateTrigger()
    TriggerRegisterTimerEventSingle(fk, 0.1)
    TriggerAddAction(fk, NeiGongJiaChengS)

end
init()