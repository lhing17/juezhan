---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by G_Seinfeld.
--- DateTime: 2018/11/15 21:38
---
--杀怪(进攻怪及练功房)
function ey()
    return IsUnitEnemy(GetDyingUnit(), GetOwningPlayer(GetKillingUnit())) and (GetOwningPlayer(GetTriggerUnit()) == Player(6) or GetOwningPlayer(GetTriggerUnit()) == Player(7))
end
function KillGuai()
    local id = GetHandleId(GetTriggeringTrigger())
    local cx = LoadInteger(YDHT, id, -807506826)
    local i = 1
    cx = cx + 3
    SaveInteger(YDHT, id, -807506826, cx)
    SaveInteger(YDHT, id, -320330265, cx)
    if GetOwningPlayer(GetTriggerUnit()) == Player(7) then
        if UnitHaveItem(udg_hero[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))], 1227896391) then
            T7 = GetRandomReal(0.95, 0.95 + I2R(fuyuan[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))]) / 50.0)
            U7 = T7 * (30.0 * (I2R(game.variable.wave + 1) / 1.0))
            AdjustPlayerStateBJ(R2I(U7), GetOwningPlayer(GetKillingUnit()), PLAYER_STATE_RESOURCE_GOLD)
        else
            T7 = GetRandomReal(0.95, 0.95 + I2R(fuyuan[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))]) / 50.0)
            U7 = T7 * (15.0 * (I2R(game.variable.wave + 1) / 1.0))
            AdjustPlayerStateBJ(R2I(U7), GetOwningPlayer(GetKillingUnit()), PLAYER_STATE_RESOURCE_GOLD)
        end
        if UnitHaveItem(udg_hero[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))], 1227896393) then
            if GetRandomInt(1, 100) <= 15 then
                AdjustPlayerStateBJ(1, GetOwningPlayer(GetKillingUnit()), PLAYER_STATE_RESOURCE_LUMBER)
            end
        end
        if UnitHaveItem(udg_hero[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))], 1227896390) then
            shengwang[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))] = shengwang[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))] + game.variable.wave // 5
        end
        if UnitHaveItem(udg_hero[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))], 1227896392) then
            AddHeroXP(udg_hero[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))], GetUnitLevel(GetTriggerUnit()) * 20, true)
        end
    else
        T7 = GetRandomReal(0.95, 0.95 + I2R(fuyuan[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))]) / 50.0)
        U7 = T7 * (25.0 * (I2R(game.variable.wave + 1) / 1.0))
        AdjustPlayerStateBJ(R2I(U7), GetOwningPlayer(GetKillingUnit()), PLAYER_STATE_RESOURCE_GOLD)
        if GetUnitPointValue(GetTriggerUnit()) == 102 then
            i = 1
            for _ in _loop_() do
                if i >= 6 then break end
                shoujiajf[i] = shoujiajf[i] + 15 * (10 - et.player.countAlive()) // 10
                i = i + 1
            end
            ae = ae + (10 + GetPlayerTechCountSimple(1378889777, Player(6)))
            DisplayTextToForce(bj_FORCE_ALL_PLAYERS, "击杀名门高手，每位玩家获得守家积分+" .. (I2S(shoujiajf[i] + 15 * (10 - et.player.countAlive()) // 10) or ""))
            SaveLocationHandle(YDHT, id * cx, 392811314, GetUnitLoc(GetTriggerUnit()))
            if GetRandomInt(1, 50) <= 5 then
                createitemloc(YaoCao[GetRandomInt(1, 12)], LoadLocationHandle(YDHT, id * cx, 392811314))
                if udg_lddsbool[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))] then
                    createitemloc(YaoCao[GetRandomInt(1, 12)], LoadLocationHandle(YDHT, id * cx, 392811314))
                end
            end
            if GetRandomInt(1, 50) <= 2 then
                createitemloc(1227897138, LoadLocationHandle(YDHT, id * cx, 392811314))
            else
                if GetRandomInt(1, 100) <= 10 then
                    createitemloc(1227896398, LoadLocationHandle(YDHT, id * cx, 392811314))
                else
                    if GetRandomInt(1, 90) <= 10 then
                        createitemloc(1227896395, LoadLocationHandle(YDHT, id * cx, 392811314))
                    else
                        if GetRandomInt(1, 80) <= 10 then
                            createitemloc(1227896397, LoadLocationHandle(YDHT, id * cx, 392811314))
                        end
                    end
                end
            end
            RemoveLocation(LoadLocationHandle(YDHT, id * cx, 392811314))
        else
            --判断是否为进攻BOSS
            if GetUnitPointValue(GetTriggerUnit()) == 101 then
                i = 1
                for _ in _loop_() do
                    if i >= 6 then break end
                    shoujiajf[i] = shoujiajf[i] + 30 * (10 - et.player.countAlive()) // 10
                    i = i + 1
                end
                ae = ae + (10 + GetPlayerTechCountSimple(1378889777, Player(6)))
                DisplayTextToForce(bj_FORCE_ALL_PLAYERS, "击杀BOSS，每位玩家获得守家积分+" .. (I2S(shoujiajf[i] + 30 * (10 - et.player.countAlive()) // 10) or ""))
                ae = ae + (30 + GetPlayerTechCountSimple(1378889777, Player(6)))
                if GetRandomInt(1, 100) <= 50 then
                    udg_shuxing[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))] = udg_shuxing[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))] + 1
                    DisplayTextToForce(bj_FORCE_ALL_PLAYERS, "|cFF33CC00" .. (GetPlayerName(GetOwningPlayer(GetKillingUnit())) or "") .. "|cFF33CC00击杀了BOSS" .. (GetUnitName(GetTriggerUnit()) or "") .. "|cFF33CC00获得了一个自由属性点")
                end
                SaveLocationHandle(YDHT, id * cx, 392811314, GetUnitLoc(GetTriggerUnit()))
                createitemloc(YaoCao[GetRandomInt(1, 12)], LoadLocationHandle(YDHT, id * cx, 392811314))
                createitemloc(YaoCao[GetRandomInt(1, 12)], LoadLocationHandle(YDHT, id * cx, 392811314))
                if udg_lddsbool[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))] then
                    createitemloc(YaoCao[GetRandomInt(1, 12)], LoadLocationHandle(YDHT, id * cx, 392811314))
                    createitemloc(YaoCao[GetRandomInt(1, 12)], LoadLocationHandle(YDHT, id * cx, 392811314))
                end
                RemoveLocation(LoadLocationHandle(YDHT, id * cx, 392811314))
            else
                if GetKillingUnit() ~= nil then
                    shoujiajf[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))] = shoujiajf[1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))] + 1
                end
            end
        end
    end
    FlushChildHashtable(YDHT, id * cx)
end

--杀怪加声望
function Xa()
    return GetPlayerController(GetOwningPlayer(GetKillingUnit())) == MAP_CONTROL_USER
end
function Ya()
    local u = GetTriggerUnit()
    local p = GetOwningPlayer(u)
    local i = 1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))
    local x
    local y
    shengwang[i] = shengwang[i] + game.variable.wave // 7 + 1
    if ModuloInteger(GetUnitPointValue(u), 10) == 1 then
        shengwang[i] = shengwang[i] + 8
    end
    if p == Player(6) then
        zd = zd + GetRandomInt(1, 2)
        if zd >= 100 then
            zd = 0
            x = GetUnitX(u)
            y = GetUnitY(u)
            createitem(gudong[GetRandomInt(1, 6 + game.variable.wave // 5)], x, y)
        end
    end
    u = nil
    p = nil
end
function dB()
    return GetPlayerController(GetOwningPlayer(GetKillingUnit())) == MAP_CONTROL_USER
end
function eB()
    local i = 1 + GetPlayerId(GetOwningPlayer(GetKillingUnit()))
    shengwang[i] = shengwang[i] + 1
    if ModuloInteger(GetUnitPointValue(GetTriggerUnit()), 10) == 1 then
        shengwang[i] = shengwang[i] + 5
    elseif ModuloInteger(GetUnitPointValue(GetTriggerUnit()), 10) == 2 then
        shengwang[i] = shengwang[i] + 10
    end
end
function ja()
    return game.variable.attack_creeps[jass.GetTriggerUnit()]
end
function ka()
    game.variable.attack_creeps[jass.GetTriggerUnit()] = nil
end
local function init()
    -- 杀进攻怪及练功房怪
    gi = CreateTrigger()
    TriggerRegisterAnyUnitEventBJ(gi, EVENT_PLAYER_UNIT_DEATH)
    TriggerAddCondition(gi, Condition(ey))
    TriggerAddAction(gi, KillGuai)
    -- 杀怪加声望
    Aj = CreateTrigger()
    TriggerRegisterPlayerUnitEventSimple(Aj, Player(6), EVENT_PLAYER_UNIT_DEATH)
    TriggerRegisterPlayerUnitEventSimple(Aj, Player(7), EVENT_PLAYER_UNIT_DEATH)
    TriggerAddCondition(Aj, Condition(Xa))
    TriggerAddAction(Aj, Ya)
    aj = CreateTrigger()
    TriggerRegisterPlayerUnitEventSimple(aj, Player(12), EVENT_PLAYER_UNIT_DEATH)
    TriggerAddCondition(aj, Condition(dB))
    TriggerAddAction(aj, eB)
    -- 将死亡单位从单位组移除
    mj = CreateTrigger()
    TriggerRegisterPlayerUnitEventSimple(mj, Player(6), EVENT_PLAYER_UNIT_DEATH)
    TriggerAddCondition(mj, Condition(ja))
    TriggerAddAction(mj, ka)
end
init()