---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by G_Seinfeld.
--- DateTime: 2018/11/16 12:56
---
local buff_list = { 1111847784, 1110454602, 1110454323, 1113813609, 1110454324, 1110454342, 1110454343 }
local function init()
    et.game:event '单位-攻击'(function(self, source, target)
        if source:has_buff(1110454322) then
            if source:get_life() <= 0.001 * source:get_max_life() then
                source:set_life(1)
            else
                source:set_life(source:get_life() - 0.001 * source:get_max_life())
            end
        end
        if source:has_buff(1112437615) then
            if source:get_life() <= 0.003 * source:get_max_life() then
                source:set_life(1)
            else
                source:set_life(source:get_life() - 0.003 * source:get_max_life())
            end
        end
    end)

    et.loop(1000, function()
        local group = et.selector():add_filter(function(u)
            for _, v in ipairs(buff_list) do
                if u:has_buff(v) then
                    return true
                end
            end
            return false
        end)            :get()
        for _, v in ipairs(group) do
            if v:has_buff(1111847784) then
                if v:get_life() <= 0.001 * v:get_max_life() then
                    v:set_life(1)
                else
                    v:set_life(v:get_life() - 0.001 * v:get_max_life())
                end
            end
            if v:has_buff(1110454602) or v:has_buff(1110454324) then
                if v:get_life() <= 0.003 * v:get_max_life() then
                    v:set_life(1)
                else
                    v:set_life(v:get_life() - 0.003 * v:get_max_life())
                end
            end
            if v:has_buff(1110454323) then
                if v:get_life() <= 0.002 * v:get_max_life() then
                    v:set_life(1)
                else
                    v:set_life(v:get_life() - 0.002 * v:get_max_life())
                end
            end
            if v:has_buff(1113813609) then
                local pt = v:get_point() - { math.rad(commonutil.random(0, 360)), 256 }
                v:issue_order(851986, pt)
            end
            if v:has_buff(1110454342) then
                if math.fmod(v:get_point_value(), 10) ~= 0 then
                    if v:get_life() <= 0.01 * v:get_max_life() then
                        v:set_life(1)
                    else
                        v:set_life(v:get_life() - 0.01 * v:get_max_life())
                    end
                else
                    if v:get_life() <= 0.03 * v:get_max_life() then
                        v:set_life(1)
                    else
                        v:set_life(v:get_life() - 0.03 * v:get_max_life())
                    end
                end
            end
            if v:has_buff(1110454342) then
                et.tag.create("脑神丹效果", v:get_point(), 12, 60, 65, 55, 42, 0, 3, 100, 90)
            end
            if v:has_buff(1110454343) then
                v:set_life(v:get_life() * 0.97)
                et.tag.create("化尸粉效果", v:get_point(), 12, 60, 65, 55, 42, 0, 3, 100, 90)
            end
        end
    end)

end
init()