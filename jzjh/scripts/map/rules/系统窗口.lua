---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by G_Seinfeld.
--- DateTime: 2018/11/15 19:49
---

function DuoMianBan(mb, zv, Av, Iv)
    local cv = 0
    local Dv = 0
    local Ev = MultiboardGetRowCount(mb)
    local Fv = MultiboardGetColumnCount(mb)
    local Gv = nil
    for _ in _loop_() do
        cv = cv + 1
        if cv > Ev then
            break
        end
        if Av == 0 or Av == cv then
            Dv = 0
            for _ in _loop_() do
                Dv = Dv + 1
                if Dv > Fv then
                    break
                end
                if zv == 0 or zv == Dv then
                    Gv = MultiboardGetItem(mb, cv - 1, Dv - 1)
                    MultiboardSetItemValue(Gv, Iv)
                    MultiboardReleaseItem(Gv)
                end
            end
        end
    end
    Gv = nil
end


-- 保留多少位小数，默认为2位
local function get_precise_decimal(nNum, n)
    if type(nNum) ~= "number" then
        return nNum;
    end

    n = n or 2;
    n = math.floor(n)
    local fmt = '%.' .. n .. 'f'
    local nRet = tonumber(string.format(fmt, nNum))

    return nRet;
end

-- 将数字转化为字符串，并用万和亿进行简化
local function get_num_string(num)
    local s
    if num < 10000.0 then
        s = '' .. get_precise_decimal(num)
    elseif num < 100000000.0 then
        s = '' .. get_precise_decimal(num / 10000) .. "万"
    elseif num / 10000.0 < 100000000.0 then
        s = '' .. get_precise_decimal(num / 10000 / 10000) .. "亿"
    elseif num / 100000000.0 < 100000000.0 then
        s = '' .. get_precise_decimal(num / 10000 / 10000 / 10000) .. "万亿"
    else
        s = '' .. get_precise_decimal(num / 10000 / 10000 / 10000 / 10000) .. "亿亿"
    end
    return s
end

local function init()
    -- 首次显示系统窗口信息
    et.wait(10 * 1000, function()
        CreateMultiboardBJ(5, 20, "系统窗口")
        MultiboardSetItemsStyle(bj_lastCreatedMultiboard, true, false)
        MultiboardSetItemsWidth(bj_lastCreatedMultiboard, 0.07)
        for i = 1, 5 do
            local s = get_num_string(udg_MaxDamage[i])
            MultiboardSetTitleText(bj_lastCreatedMultiboard, "|cFFFFCC33萌萌哒系统窗口")
            DuoMianBan(bj_lastCreatedMultiboard, 1, 4 * i - 3, "|c00FF0080" .. (GetPlayerName(Player(i - 1)) or ""))
            DuoMianBan(bj_lastCreatedMultiboard, 2, 4 * i - 3, "|c0000FF00" .. "等级：" .. (I2S(GetUnitLevel(udg_hero[i])) or ""))
            DuoMianBan(bj_lastCreatedMultiboard, 3, 4 * i - 3, "|cFF00CCFF" .. (udg_menpainame[udg_runamen[i]] or ""))
            DuoMianBan(bj_lastCreatedMultiboard, 4, 4 * i - 3, "|cFFFF6600" .. "最高伤害：" .. (s or ""))
            if Ce[i] == 1 then
                DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99炼丹师")
            elseif Ce[i] == 2 then
                DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99锻造师")
            elseif Ce[i] == 3 then
                DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99兵器师")
            elseif Ce[i] == 4 then
                DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99鉴定师")
            elseif Ce[i] == 5 then
                DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99练气师")
            elseif Ce[i] == 6 then
                DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99寻宝师")
            elseif Ce[i] == 7 then
                DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99丫鬟")
            elseif Ce[i] == 8 then
                DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99精武师")
            else
                DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99未选择")
            end
            if I7[20 * (i - 1) + 1] ~= 1095067243 then
                DuoMianBan(bj_lastCreatedMultiboard, 1, 4 * i - 2, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 1]) or ""))
            end
            if I7[20 * (i - 1) + 2] ~= 1095067243 then
                DuoMianBan(bj_lastCreatedMultiboard, 2, 4 * i - 2, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 2]) or ""))
            end
            if I7[20 * (i - 1) + 3] ~= 1095067243 then
                DuoMianBan(bj_lastCreatedMultiboard, 3, 4 * i - 2, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 3]) or ""))
            end
            if I7[20 * (i - 1) + 4] ~= 1095067243 then
                DuoMianBan(bj_lastCreatedMultiboard, 4, 4 * i - 2, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 4]) or ""))
            end
            if I7[20 * (i - 1) + 5] ~= 1095067243 then
                DuoMianBan(bj_lastCreatedMultiboard, 1, 4 * i - 1, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 5]) or ""))
            end
            if I7[20 * (i - 1) + 6] ~= 1095067243 then
                DuoMianBan(bj_lastCreatedMultiboard, 2, 4 * i - 1, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 6]) or ""))
            end
            if I7[20 * (i - 1) + 7] ~= 1095067243 then
                DuoMianBan(bj_lastCreatedMultiboard, 3, 4 * i - 1, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 7]) or ""))
            end
            if I7[20 * (i - 1) + 8] ~= 1095067243 then
                DuoMianBan(bj_lastCreatedMultiboard, 4, 4 * i - 1, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 8]) or ""))
            end
            if I7[20 * (i - 1) + 9] ~= 1095067243 then
                DuoMianBan(bj_lastCreatedMultiboard, 1, 4 * i, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 9]) or ""))
            end
            if I7[20 * (i - 1) + 10] ~= 1095067243 then
                DuoMianBan(bj_lastCreatedMultiboard, 2, 4 * i, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 10]) or ""))
            end
            if I7[20 * (i - 1) + 11] ~= 1095067243 then
                DuoMianBan(bj_lastCreatedMultiboard, 3, 4 * i, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 11]) or ""))
            end
        end
        MultiboardDisplay(bj_lastCreatedMultiboard, true)

        -- 刷新系统窗口信息

        et.loop(4, function()
            for i = 1, 5 do
                local s = get_num_string(udg_MaxDamage[i])
                MultiboardSetTitleText(bj_lastCreatedMultiboard, "|cFFFFCC33萌萌哒系统窗口")
                DuoMianBan(bj_lastCreatedMultiboard, 1, 4 * i - 3, "|c00FF0080" .. (GetPlayerName(Player(i - 1)) or ""))
                DuoMianBan(bj_lastCreatedMultiboard, 2, 4 * i - 3, "|c0000FF00" .. "等级：" .. (I2S(GetUnitLevel(udg_hero[i])) or ""))
                DuoMianBan(bj_lastCreatedMultiboard, 3, 4 * i - 3, "|cFF00CCFF" .. (udg_menpainame[udg_runamen[i]] or ""))
                DuoMianBan(bj_lastCreatedMultiboard, 4, 4 * i - 3, "|cFFFF6600" .. "最高伤害：" .. (s or ""))
                if Ce[i] == 1 then
                    DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99炼丹师")
                elseif Ce[i] == 2 then
                    DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99锻造师")
                elseif Ce[i] == 3 then
                    DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99兵器师")
                elseif Ce[i] == 4 then
                    DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99鉴定师")
                elseif Ce[i] == 5 then
                    DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99练气师")
                elseif Ce[i] == 6 then
                    DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99寻宝师")
                elseif Ce[i] == 7 then
                    DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99丫鬟")
                elseif Ce[i] == 8 then
                    DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99精武师")
                else
                    DuoMianBan(bj_lastCreatedMultiboard, 5, 4 * i - 3, "|c00FFEE99未选择")
                end
                if I7[20 * (i - 1) + 1] ~= 1095067243 then
                    DuoMianBan(bj_lastCreatedMultiboard, 1, 4 * i - 2, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 1]) or ""))
                end
                if I7[20 * (i - 1) + 2] ~= 1095067243 then
                    DuoMianBan(bj_lastCreatedMultiboard, 2, 4 * i - 2, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 2]) or ""))
                end
                if I7[20 * (i - 1) + 3] ~= 1095067243 then
                    DuoMianBan(bj_lastCreatedMultiboard, 3, 4 * i - 2, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 3]) or ""))
                end
                if I7[20 * (i - 1) + 4] ~= 1095067243 then
                    DuoMianBan(bj_lastCreatedMultiboard, 4, 4 * i - 2, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 4]) or ""))
                end
                if I7[20 * (i - 1) + 5] ~= 1095067243 then
                    DuoMianBan(bj_lastCreatedMultiboard, 1, 4 * i - 1, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 5]) or ""))
                end
                if I7[20 * (i - 1) + 6] ~= 1095067243 then
                    DuoMianBan(bj_lastCreatedMultiboard, 2, 4 * i - 1, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 6]) or ""))
                end
                if I7[20 * (i - 1) + 7] ~= 1095067243 then
                    DuoMianBan(bj_lastCreatedMultiboard, 3, 4 * i - 1, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 7]) or ""))
                end
                if I7[20 * (i - 1) + 8] ~= 1095067243 then
                    DuoMianBan(bj_lastCreatedMultiboard, 4, 4 * i - 1, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 8]) or ""))
                end
                if I7[20 * (i - 1) + 9] ~= 1095067243 then
                    DuoMianBan(bj_lastCreatedMultiboard, 1, 4 * i, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 9]) or ""))
                end
                if I7[20 * (i - 1) + 10] ~= 1095067243 then
                    DuoMianBan(bj_lastCreatedMultiboard, 2, 4 * i, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 10]) or ""))
                end
                if I7[20 * (i - 1) + 11] ~= 1095067243 then
                    DuoMianBan(bj_lastCreatedMultiboard, 3, 4 * i, "|c0000FF00" .. (GetObjectName(I7[20 * (i - 1) + 11]) or ""))
                end
            end
        end)
    end)


    --最大伤害
    function wy()
        return GetPlayerController(GetOwningPlayer(GetTriggerUnit())) ~= MAP_CONTROL_USER and GetEventDamage() > udg_MaxDamage[1 + GetPlayerId(GetOwningPlayer(GetEventDamageSource()))]
    end
    function SetMaxDamage()
        udg_MaxDamage[1 + GetPlayerId(GetOwningPlayer(GetEventDamageSource()))] = GetEventDamage()
    end
    -- 计算玩家最大伤害
    ni = CreateTrigger()
    YDWESyStemAnyUnitDamagedRegistTrigger(ni)
    TriggerAddCondition(ni, Condition(wy))
    TriggerAddAction(ni, SetMaxDamage)
end
init()