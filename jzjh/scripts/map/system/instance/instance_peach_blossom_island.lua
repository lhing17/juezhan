---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by G_Seinfeld.
--- DateTime: 2018/12/7 16:08
---

local island_open_flag = false

--- @param u unit
--- @param it item
et.game:event '单位-捡起物品' (function(self, u, it)
    if it:get_id() == 1227897171 then
        local p = u:get_owner()
        if not island_open_flag then
            p:send_message("|cFFFFCC00桃花岛尚未开放")
            p:add_gold(500)
            return
        end
        if not u:is_hero() then
            p:send_message("|cFFFFCC00只能由主角亲自前往")
            p:add_gold(500)
            return
        end
        u:set_point(et.point(9631, 1139))
        p:set_camera(et.point(9631, 1139))
        force.send_message("|cFFFFCC00有玩家进入桃花岛")
        force.send_message("|cFFFFCC00“源思英年,巴巴西洛普,雪陆文出；源思英年,巴巴西洛普,雪陆文出！”")
    end
end)

function island_wait_open()
    et.wait(1800 * 1000, function()
        island_open_flag = true
        force.send_message("|cFFFFCC00桃花岛已开放，你可以由正派武林右侧NPC我是随风处进入")
        force.ping_minimap(9631, 1139, 5)
        island_wait_close()
    end)
    et.timerdialog(1800, "桃花岛开放倒计时：")
end

function island_wait_close()
    et.wait(600 * 1000, function()
        island_open_flag = false
        for i = 1, 5 do
            --- @type unit
            local u = et.unit(et.player[i].hero.handle)
            if rect_peach_blossom_island:contains_unit(u) then
                u:set_point(et.point(-1174, -678))
                u:get_owner():set_camera(et.point(-1174, -678))
                u:get_owner():send_message("|cFFFFCC00时间到，离开桃花岛")
            end
        end
        island_wait_open()
    end)
    et.timerdialog(600, "桃花岛关闭倒计时：")
end

--- 初始等待桃花岛开放
island_wait_open()

local island_drop = {
    [1869050475] = 1227899185,
    [1853058150] = 1227897154,
    [1853320818] = 1227897143,
    [1865429553] = 1227896375,
    [1865429554] = 1227896369,
    [1848651841] = 1227896368,
    [1848651844] = 1227897159,
}

--- @param killer unit
--- @param killed unit
et.game:event '单位-死亡' (function(self, killer, killed)
    if rect_peach_blossom_island:contains_unit(killer) then
        if island_drop[killed:get_id()] then
            killer:set_point(-1174, -678)
            killer:get_owner():set_camera(-1174, -678)
            force.send_message( "|cFFFFCC00有玩家杀死了" .. killed:get_name() .. "，离开桃花岛")
            if commonutil.random(0, 100) <= 30 then
                killer:add_item(island_drop[killed:get_id()])
            end
        end
    end
end)

