---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by G_Seinfeld.
--- DateTime: 2018/12/17 14:04
---

--- 大力金刚指
--- @param u unit
--- @param id number
--- @param target unit
et.game:event '单位-技能生效'(function(self, u, id, target)
    if id == 1093678411 and u:is_hero() then
        local group = {}
        if u:has_ability(1093678932) and u:has_ability(1093678927) then
            group = et.selector():in_range(target:get_point(), 500):is_enemy(u):get()
        else
            table.insert(group, target)
        end
        local coeff = 1
        coeff = coeff + (u:has_ability(1093678664) and 0.8 or 0)
        coeff = coeff + (u:has_ability(1093682254) and 0.6 or 0)
        coeff = coeff + (u:has_all_abilities(1093678930, 1093678928) and 1 or 0)
        coeff = coeff * (u:has_item(1227899212) and 3 or 1)
        local p = u:get_owner()
        local h = p.hero
        for _, v in pairs(group) do
            local ability_damage, critical = damage_formula {
                source = u,
                target = v,
                magic_coeff = 1,
                physic_coeff = 1,
                ability_coeff = 200 * coeff * (u:has_ability(1093678931) and 1.5 or 1),
                level = u:get_ability_level(1093678411)
            }
            apply_damage(u, v, ability_damage, critical)
            if h['根骨'] >= 20 and not v:has_buff(1110454328) then
                if u:has_ability(1093678672) then
                    u:apply_buff(v, "穴位全封")
                else
                    u:apply_buff(v, "封穴")
                end
            end
            -- 悟性超过20时50%概率斩杀低于20%血的怪物
            if h['悟性'] >= 20 and v:get_life_percent() <= 20 and commonutil.random(0, 100) < 50 then
                h:kill_unit(v)
                et.tag.create("斩杀", v:get_point(), 16, 60, 65, 55, 42, 0, 3)
            end
            if u:has_ability(1093678930) and u:has_ability(1093678928) and not v:has_buff(1113813619) then
                u:apply_buff(v, "神经错乱")
            end
        end
    end
end)


