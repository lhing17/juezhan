---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by G_Seinfeld.
--- DateTime: 2018/12/17 14:07
---

--- 降魔功
--- @param killer unit
--- @param killed unit
et.game:event '单位-死亡'(function(self, killer, killed)
    if killer:has_ability(1395666992) then
        local p = killer:get_owner()
        local h = p.hero
        h.xiang_mo_value = h.xiang_mo_value or 0 + 1
        if h.xiang_mo_value >= 10 then
            h.xiang_mo_value = h.xiang_mo_value - 10
            killer:set_agi(killer:get_agi() + 1)
        end
    end
end)

--- @param source unit
--- @param target unit
et.game:event '单位-受攻击'(function(self, source, target)
    if target:has_ability(1395666992) then
        local p = target:get_owner()
        local h = p.hero
        --- +神照经
        if target:has_ability(1093678936) then
            h.xiang_mo_value2 = h.xiang_mo_value2 or 0 + 1
            if h.xiang_mo_value2 >= 10 then
                h.xiang_mo_value2 = h.xiang_mo_value2 - 10
                for i = 1, 18 do
                    dummy_issue_order {
                        target = target:get_point() - { 20 * i, 256 },
                        player = target:get_owner(),
                        ability_id = 1093678416,
                        order_id = 852218,
                        lifetime = 2
                    }
                end
            end
        end
    end
    if source:has_ability(1395666992) then
        local p = source:get_owner()
        local h = p.hero
        if source:has_ability(1093678931) and source:has_ability(1093682254) and commonutil.random(0, 100) <= 2 then
            local last = p:create_unit(1852862002, source:get_point())
            last:set_lifetime(180)
        end
        if source:has_ability(1395666994) then
            if target:get_life() <= 0.01 * target:get_max_life() then
                target:set_life(1)
            else
                target:set_life(target:get_life() - target:get_max_life() * 0.01)
            end
        end
    end
end)

--- @param source unit
--- @param target unit
--- @param damage number
et.game:event '单位-受到伤害' (function(self, source, target, damage)
    if damage ~= 0.18 then
         return
    end
    local coeff = 1 * (source:has_item(1227899212) and 3 or 1)
    local ability_damage, critical = damage_formula {
        source = source,
        target = target,
        magic_coeff = 1,
        physic_coeff = 1,
        ability_coeff = 50 * coeff,
        level = source:get_ability_level(1395666992)
    }
    apply_damage(source, target, ability_damage, critical)
end)