---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by G_Seinfeld.
--- DateTime: 2018/12/21 0021 19:00
---

--- 一阳指
--- @param u unit 施法单位
--- @param id number 技能ID
--- @param target unit|point|nil 技能目标
et.game:event '单位-技能生效'(function(self, u, id, target)
    if id == 1093678672 and u:is_hero() then
        if u:has_ability(1093679152) and commonutil.random(0, 100) <= 40 then
            u:set_mana(u:get_mana() + 80)
        end
        if u:has_all_abilities(1093679428, 1093679157) then
            for i = 1, 6 do
                dummy_issue_order {
                    target = u:get_point() - { 60 * i, 200 },
                    player = u:get_owner(),
                    ability_id = 1093678672,
                    order_id = 852125,
                    lifetime = 2,
                }
            end
        end
    end
end)

--- 一阳指伤害
--- @param source unit 伤害来源
--- @param target unit 受伤害的单位
--- @param damage number 伤害的数值
et.game:event '单位-受到伤害'(function(self, source, target, damage)
    if damage ~= 0.29 or not target:is_alive() then
        return
    end
    local coeff = 1
    coeff = coeff + (source:has_ability(1093678927) and 0.6 or 0)
    coeff = coeff + (source:has_ability(1093682254) and 0.7 or 0)
    coeff = coeff * (source:has_all_abilities(1093678927, 1093682254, 1093678933, 1093679428, 1093679157, 1093679152) and 12 or 1)
    local ability_damage, critical = damage_formula {
        source = source,
        target = target,
        magic_coeff = 1,
        physic_coeff = 1,
        ability_coeff = 40 * coeff,
        level = source:get_ability_level(1093678672)
    }
    apply_damage(source, target, ability_damage, critical)
    if source:has_ability(1093678933) and source:is_hero() then
        if target:get_life() <= 0.05 * target:get_max_life() then
            target:set_invulnerable(0)
            target:set_life(1)
        else
            target:set_life(target:get_life() - 0.05 * target:get_max_life())
        end
    end
    local h = source:get_owner().hero
    if h['根骨'] >= 30 and source:is_hero() then
        source:apply_buff(target, '穴位全封')
    end
end)