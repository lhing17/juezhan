---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by G_Seinfeld.
--- DateTime: 2018/12/20 9:30
---

--- 冰魄银针
--- @param u unit 施法单位
--- @param id number 技能ID
--- @param target unit|item|point|nil 技能目标
et.game:event '单位-技能生效'(function(self, u, id, target)
    if id == 1093678913 and u:is_hero() then
        for i = 1, 12 do
            local pt = u:get_point() - { 30 * i, 256 }
            dummy_issue_order {
                target = pt,
                player = u:get_owner(),
                unit_id = 1697656880,
                ability_id = 1093678914,
                order_id = 852218,
                lifetime = 2 }
        end
        local p = u:get_owner()
        local h = p.hero
        et.wait(5000, function()
            if h.titles:contains('赤炼仙子') then
                local level = u:get_ability_level(1093678913)
                u:remove_ability(1093678913)
                u:add_ability(1093678913, level)
            end
        end)
    end
end)

--- 冰魄银针伤害
--- @param source unit 伤害来源
--- @param target unit 受伤害单位
--- @param damage number 伤害数值
et.game:event '单位-受到伤害'(function(self, source, target, damage)
    if damage ~= 0.24 then
        return
    end
    local p = source:get_owner()
    local h = p.hero
    local coeff = 1
    coeff = coeff + (source:has_ability(1093678932) and 0.6 or 0)
    coeff = coeff + (source:has_ability(1093679155) and 2 or 0)
    coeff = coeff * (source:has_all_abilities(1093678932, 1093679155, 1093678931, 1093679154) and 8 or 1)
    coeff = coeff * (h.titles:contains('赤炼仙子') and 5 or 1)
    local ability_damage, critical = damage_formula {
        source = source,
        target = target,
        magic_coeff = 1,
        physic_coeff = 1,
        ability_coeff = 26 * coeff,
        level = source:get_ability_level(1093678913)
    }
    apply_damage(source, target, ability_damage, critical)
    if source:has_ability(1093678931) then
        dummy_issue_order {
            target = target,
            player = source:get_owner(),
            unit_id = 1697656880,
            ability_id = 1093678915,
            order_id = 852226,
            lifetime = 2 }
    end
    if source:has_ability(1093679154) and h.titles:contains('赤炼仙子') then
        dummy_issue_order {
            target = target,
            player = source:get_owner(),
            unit_id = 1697656880,
            ability_id = 1093678916,
            order_id = 852209,
            lifetime = 2 }
    end
end)

--- 冰魄银针冰冻效果伤害
--- @param source unit 伤害来源
--- @param target unit 受伤害单位
--- @param damage number 伤害数值
et.game:event '单位-受到伤害'(function(self, source, target, damage)
    if damage ~= 0.25 then
        return
    end
    local p = source:get_owner()
    local h = p.hero
    local coeff = 1
    coeff = coeff + (source:has_ability(1093678932) and 0.6 or 0)
    coeff = coeff + (source:has_ability(1093679155) and 2 or 0)
    coeff = coeff * (source:has_all_abilities(1093678932, 1093679155, 1093678931, 1093679154) and 8 or 1)
    coeff = coeff * (h.titles:contains('赤炼仙子') and 5 or 1)

    local ability_damage, critical = damage_formula {
        source = source,
        target = target,
        magic_coeff = 1,
        physic_coeff = 1,
        ability_coeff = (h.titles:contains('赤炼仙子') and 26 or 6) * coeff,
        level = source:get_ability_level(1093678913)
    }
    apply_damage(source, target, ability_damage, critical)
end)
