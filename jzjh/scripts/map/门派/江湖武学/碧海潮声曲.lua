---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by G_Seinfeld.
--- DateTime: 2018/12/21 0021 19:04
---

--- 碧海潮生曲
--- @param u unit 施法单位
--- @param id number 技能ID
--- @param target unit|point|nil 技能目标
et.game:event '单位-技能生效'(function(self, u, id, target)
    if id == 1093677368 and u:is_hero() then
        et.effect.add_to_point("Abilities\\Spells\\Human\\Brilliance\\Brilliance.mdl", u:get_point())
        local group = et.selector():in_range(u:get_point(), 500):is_enemy(u):get()
        for _, v in pairs(group) do
            local tones = { "宫!", "商!", "角!", "徵!", "羽!" }
            local min = 5
            if u:has_ability(1093678664) then
                min = 3
            end
            if u:has_ability(1093682227) then
                min = commonutil.random_int(2, 5)
            end
            local index = commonutil.random_int(1, 5)
            local coeff = 1
            coeff = coeff + (u:has_ability(1093678926) and 1 or 0)
            coeff = coeff * (u:has_all_abilities(1093678664, 1093682227, 1093678926, 1093679156) or 8 and 1)
            coeff = coeff * (u:has_item(1227897156) and 3 or 1)
            if u:has_ability(1093679156) and u:has_buff(1110454361) then
                index = 5
            end
            et.tag.create(tones[index], u:get_point(), 14, 40, 10, 60, 30, 0, 1.5, 100, 90)
            if index == 1 then
                u:apply_buff(v, "内伤")
            end
            if index == 2 then
                u:apply_buff(v, "破防")
            end
            if index == 3 then
                local ability_damage, critical = damage_formula {
                    source = u,
                    target = v,
                    magic_coeff = 2,
                    physic_coeff = 3,
                    ability_coeff = 10 * coeff,
                    level = u:get_ability_level(1093677368)
                }
                apply_damage(u, v, ability_damage, critical)
                et.effect.add_to_point("Abilities\\Spells\\Items\\AIil\\AIilTarget.mdl", u:get_point()):destroy()
            end
            if index == 4 then
                u:apply_buff(v, "混乱")
            end
            if index == 5 then
                local h = u:get_owner().hero
                if not u:has_buff(1110454361) then
                    h.bi_hai_value = 1
                else
                    h.bi_hai_value = h.bi_hai_value + 1
                    u:remove_ability(1110454361)
                end
                dummy_issue_order {
                    target = v,
                    player = u:get_owner(),
                    ability_id = 1093677377,
                    order_id = 852075,
                    lifetime = 2,
                }
                if h.bi_hai_value >= min then
                    u:remove_ability(1110454361)
                    local ability_damage, critical = damage_formula {
                        source = u,
                        target = v,
                        magic_coeff = 1,
                        physic_coeff = 2,
                        ability_coeff = 800 * coeff,
                        level = u:get_ability_level(1093677368)
                    }
                    apply_damage(u, v, ability_damage, critical)
                    et.effect.add_to_point("Abilities\\Spells\\Items\\AIil\\AIilTarget.mdl", u:get_point()):destroy()
                end
            end
        end
    end
end)



