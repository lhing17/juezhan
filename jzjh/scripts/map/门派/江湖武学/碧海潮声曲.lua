---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by G_Seinfeld.
--- DateTime: 2018/12/21 0021 19:04
---

---------碧海潮生曲开始-------//
function IsBiHai()
    return IsUnitType(GetTriggerUnit(), UNIT_TYPE_HERO) ~= nil and GetSpellAbilityId() == 1093677368 -- INLINED!!
end
function BiHai_Condition()
    return IsUnitEnemy(GetFilterUnit(), GetOwningPlayer(GetTriggerUnit())) and IsUnitAliveBJ(GetFilterUnit())
end
function BiHai_Action()
    local u = GetTriggerUnit()
    local uc = GetEnumUnit()
    local loc = GetUnitLoc(uc)
    local i = GetRandomInt(1, 5)
    local j = 5
    local shxishu = 1.0
    local shanghai = 0.0
    local yinlv = _array_()
    yinlv[1] = "宫!"
    yinlv[2] = "商!"
    yinlv[3] = "角!"
    yinlv[4] = "徵!"
    yinlv[5] = "羽!"
    if GetUnitAbilityLevel(u, 1093678664) >= 1 then
        j = 3
    end
    if GetUnitAbilityLevel(u, 1093682227) >= 1 then
        j = GetRandomInt(2, 5)
    end
    if GetUnitAbilityLevel(u, 1093678926) >= 1 then
        shxishu = shxishu + 1
    end
    if GetUnitAbilityLevel(u, 1093678664) >= 1 and GetUnitAbilityLevel(u, 1093682227) >= 1 and GetUnitAbilityLevel(u, 1093678926) >= 1 and GetUnitAbilityLevel(u, 1093679156) >= 1 then
        shxishu = shxishu * 4 * 2
    end
    if UnitHaveItem(u, 1227897156) then
        shxishu = shxishu * 8
    end
    if GetUnitAbilityLevel(u, 1093679156) >= 1 and UnitHasBuffBJ(u, 1110454361) then
        i = 5
    end
    CreateTextTagLocBJ(yinlv[i], loc, 40.0, 14.0, 10.0, 60.0, 30.0, 0)
    Nw(1.5, bj_lastCreatedTextTag)
    SetTextTagVelocityBJ(bj_lastCreatedTextTag, 100.0, 90)
    if i == 1 then
        general_buff(u, uc, 1)
    elseif i == 2 then
        general_buff(u, uc, 9)
    elseif i == 3 then
        shanghai = ShangHaiGongShi(u, uc, 20, 30, shxishu, 1093677368)
        WuGongShangHai(u, uc, shanghai)
        DestroyEffect(AddSpecialEffectLocBJ(loc, "Abilities\\Spells\\Items\\AIil\\AIilTarget.mdl"))
    elseif i == 4 then
        general_buff(u, uc, 4)
    elseif i == 5 then
        if UnitHasBuffBJ(u, 1110454361) == false then
            bihai[1 + GetPlayerId(GetOwningPlayer(u))] = 1
            CreateNUnitsAtLoc(1, 1697656880, GetOwningPlayer(u), loc, bj_UNIT_FACING)
            ShowUnitHide(bj_lastCreatedUnit)
            UnitAddAbility(bj_lastCreatedUnit, 1093677377)
            IssueTargetOrderById(bj_lastCreatedUnit, 852075, uc)
            UnitApplyTimedLife(bj_lastCreatedUnit, 1112045413, 2.0)
        else
            bihai[1 + GetPlayerId(GetOwningPlayer(u))] = bihai[1 + GetPlayerId(GetOwningPlayer(u))] + 1
            UnitRemoveBuffBJ(1110454361, u)
            CreateNUnitsAtLoc(1, 1697656880, GetOwningPlayer(u), loc, bj_UNIT_FACING)
            ShowUnitHide(bj_lastCreatedUnit)
            UnitAddAbility(bj_lastCreatedUnit, 1093677377)
            IssueTargetOrderById(bj_lastCreatedUnit, 852075, uc)
            UnitApplyTimedLife(bj_lastCreatedUnit, 1112045413, 2.0)
        end
        if bihai[1 + GetPlayerId(GetOwningPlayer(u))] >= j then
            UnitRemoveBuffBJ(1110454361, u)
            DestroyEffect(AddSpecialEffectLocBJ(loc, "Abilities\\Spells\\Items\\AIil\\AIilTarget.mdl"))
            shanghai = ShangHaiGongShi(u, uc, 800, 1600, shxishu, 1093677368)
            WuGongShangHai(u, uc, shanghai)
        end
    end
    RemoveLocation(loc)
    u = nil
    uc = nil
    loc = nil
end
function BiHaiChaoSheng()
    local g = CreateGroup()
    local u = GetTriggerUnit()
    local loc = GetUnitLoc(u)
    local sd = CreateSound("Sound\\Music\\mp3Music\\UndeadVictory.mp3", false, false, false, 10, 10, "DefaultEAXON")
    DestroyEffect(AddSpecialEffectLocBJ(loc, "Abilities\\Spells\\Human\\Brilliance\\Brilliance.mdl"))
    --call PlaySoundOnUnitBJ(sd,100,u)
    WuGongShengChong(u, 1093677368, 700.0)
    GroupEnumUnitsInRangeOfLoc(g, loc, 500, Condition(BiHai_Condition))
    ForGroupBJ(g, BiHai_Action)
    GroupClear(g)
    DestroyGroup(g)
    RemoveLocation(loc)
    u = nil
    g = nil
    loc = nil
end
---------碧海潮生曲结束-------//

t = CreateTrigger()
TriggerRegisterAnyUnitEventBJ(t, EVENT_PLAYER_UNIT_SPELL_EFFECT)
TriggerAddCondition(t, Condition(IsBiHai))
TriggerAddAction(t, BiHaiChaoSheng)
t = nil

